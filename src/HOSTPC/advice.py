#!/usr/bin/env python3
import os
import sys
import json
import re
from datetime import datetime
from transformers import pipeline
from gtts import gTTS
import subprocess

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ì„¤ì •
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
BASE_DIR      = os.path.dirname(__file__)
RESULT_PATH   = os.path.join(BASE_DIR, "result.txt")        # ë‹¨ì¼ ê°ì • ë¶„ì„ JSON
LOG_PATH      = os.path.join(BASE_DIR, "emotion_log.txt")   # ë‚ ì§œë³„ ë¡œê·¸
MODEL_NAME    = "google/flan-t5-small"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# TTS ì¬ìƒ (gTTS + mpg123)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def speak(text: str):
    tmp_mp3 = os.path.join(BASE_DIR, "advice.mp3")
    tts = gTTS(text=text, lang="ko")
    tts.save(tmp_mp3)
    subprocess.run(["mpg123", "-q", tmp_mp3])
    os.remove(tmp_mp3)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ê°ì • ë°ì´í„° ë¡œë“œ
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def load_emotions(path):
    with open(path, encoding="utf-8") as f:
        return json.load(f)

def summarize_top4(emotions: dict) -> str:
    top4 = sorted(emotions.items(), key=lambda kv: kv[1], reverse=True)[:4]
    return " / ".join(f"{k[:3]}:{v:.2f}" for k, v in top4)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# sadê°€ ìƒìœ„ 4ê°œì— í¬í•¨ëœ ì¼ì ì§‘ê³„
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def count_sad_days(log_path):
    if not os.path.exists(log_path):
        return 0
    sad_dates = set()
    current_date = None
    with open(log_path, encoding="utf-8") as f:
        for line in f:
            line = line.strip()
            # ë‚ ì§œ ë¼ì¸ (YYYY-MM-DD HH:MM:SS)
            m = re.match(r'^(\d{4}-\d{2}-\d{2}) ', line)
            if m:
                current_date = m.group(1)
            elif current_date and "sad:" in line.lower():
                sad_dates.add(current_date)
                current_date = None
    return len(sad_dates)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ë¡œì»¬ ëª¨ë¸ ì´ˆê¸°í™”
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
_generator = None
def get_generator():
    global _generator
    if _generator is None:
        _generator = pipeline(
            "text2text-generation",
            model=MODEL_NAME,
            device="cpu",
            max_new_tokens=100,
            do_sample=False
        )
    return _generator

def generate_model_advice(summary: str) -> str:
    prompt = (
        f"ê°ì • ë¶„ì„ ê²°ê³¼ ìƒìœ„ 4ê°œ ê°ì •ì…ë‹ˆë‹¤: {summary}.\n"
        "ì´ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ ê°„ë‹¨í•œ ë§ˆìŒ ê´€ë¦¬ ë° ê¸°ë¶„ ì „í™˜ ë°©ë²•ì„ í•œêµ­ì–´ë¡œ ì œì•ˆí•´ ì£¼ì„¸ìš”."
    )
    gen = get_generator()
    out = gen(prompt)
    text = out[0]["generated_text"]
    return text.replace("<s>", "").replace("</s>", "").strip() or \
           "ê°„ë‹¨í•œ ê¸°ë¶„ ì „í™˜ ë°©ë²•ì„ ì‹œë„í•´ ë³´ì„¸ìš”."

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ë©”ì¸
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def main():
    # 1) result.txt ë¡œë“œ ë° ìš”ì•½
    emotions = load_emotions(RESULT_PATH)
    summary  = summarize_top4(emotions)
    print("ğŸ” ìƒìœ„ 4ê°œ ê°ì • ìš”ì•½:", summary)

    # 2) sad í¬í•¨ ì¼ìˆ˜ í™•ì¸
    days_sad = count_sad_days(LOG_PATH)
    print(f"ğŸ“… sadê°€ ìƒìœ„ 4ê°œì— ë“  ì¼ìˆ˜: {days_sad}ì¼")

    # 3) ì¡°ê±´ì— ë”°ë¥¸ ê³ ì • ì¡°ì–¸
    if days_sad >= 7:
        advice = "ìš”ì¦˜ ìš°ìš¸í•œ ê°ì •ì´ ê³„ì† ë“œë„¤ìš” ë³‘ì›ì„ ê°€ë³´ì‹œëŠ”ê±´ ì–´ë–¤ê°€ìš”"
    elif days_sad >= 3:
        advice = "ê°€ë²¼ìš´ ì‚°ì±…ì„ í†µí•´ í™œê¸°ë¥¼ ê°€ì ¸ë³´ì„¸ìš”"
    elif days_sad >= 2:
        advice = "ìš”ì¦˜ ìš°ìš¸í•œ ê°ì •ì´ ë“œëŠ”ê±° ê°™ì•„ìš” ê¸°ë¶„ì„ í™˜ê¸° ì‹œì¼œ ë³´ì„¸ìš”"
    else:
        # 4) ì¡°ê±´ ë¯¸ì¶©ì¡± ì‹œ ëª¨ë¸ ê¸°ë°˜ ì¡°ì–¸
        print("ğŸ’¡ ëª¨ë¸ ê¸°ë°˜ ì¡°ì–¸ ìƒì„± ì¤‘â€¦")
        advice = generate_model_advice(summary)

    # 5) ê²°ê³¼ ì¶œë ¥ ë° ìŒì„± ì•ˆë‚´
    print("\n=== ì¡°ì–¸ ===")
    print(advice)
    print("\nğŸ”Š ìŒì„± ì¬ìƒ ì¤‘â€¦")
    speak(advice)

if __name__ == "__main__":
    main()

